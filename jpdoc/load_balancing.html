<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:rss="http://purl.org/rss/1.0/" xml:lang="ja" lang="ja"><head><meta http-equiv="Content-type" content="text/html; charset=UTF-8"></meta><meta http-equiv="Content-style-type" content="text/css; charset=UTF-8"></meta><meta http-equiv="Content-script-type" content="text/javascript; charset=UTF-8"></meta><title>
					Gentoo Linux Users Group Japan
					
						&#8211;
						Gentoo Linux 負荷分散ガイド</title><link title="new" rel="stylesheet" href="/css/main.css" type="text/css"></link><link title="new" rel="stylesheet" href="/css/gentoojp.css" type="text/css"></link><link rev="Made" href="mailto:www@gentoo.gr.jp"></link><link rel="alternate" type="application/rss+xml" title="GentooJP News" href="/gentoojp-news.xml"></link></head><body><div class="logo"><p>日本語：
							[ <a href="http://www.gentoo.gr.jp/">GentooJP</a> ]
							[ <a href="http://wiki.gentoo.gr.jp/">Wiki</a> ]
							</p><p>英語：
							[ <a href="http://www.gentoo.org/">Gentoo.org</a> ]
							[ <a href="http://packages.gentoo.org/">Packages</a> ]
							[ <a href="http://forums.gentoo.org/">Forums</a> ]
              [ <a href="http://bugs.gentoo.org/">Bugzilla</a> ]
              [ <a href="http://wiki.gentoo.org/">Wiki</a> ]</p></div><table class="all" width="99%"><tr><td><div class="navi" align="center"><span><a href="/">トップに戻る</a></span></div></td></tr></table><table border="0" style="margin:0em ! important;" cellspacing="5" width="100%"><tr><td class="sidebar" valign="top" rowspan="2"><h4>はじめに</h4><ul><li><a href="/jpmain/about-gentoojp.html">GentooJPについて</a></li><li><a href="/jpmain/arukikata.html">Gentooの歩き方</a></li><li><a href="/jpmain/contribution.html">Gentooへの貢献</a></li><li><a href="/jpmain/docs-list.html">各種ドキュメント</a></li></ul><h4><a href="http://www.gentoo.org/doc/ja/handbook/handbook-x86.xml">ハンドブック</a></h4><ul><li><a href="http://www.gentoo.org/doc/ja/handbook/handbook-x86.xml?part=1&amp;chap=0">Gentooをインストールする</a></li><li><a href="http://www.gentoo.org/doc/ja/handbook/handbook-x86.xml?part=2&amp;chap=0">Gentooを使いこなす</a></li><li><a href="http://www.gentoo.org/doc/ja/handbook/handbook-x86.xml?part=3&amp;chap=0">Portageを使いこなす</a></li></ul><h4><a href="http://www.gentoo.org/doc/ja/index.xml">翻訳ドキュメント</a></h4><ul><li><a href="http://www.gentoo.org/doc/ja/index.xml?catid=faq">FAQ (よくある質問)</a></li><li><a href="http://www.gentoo.org/doc/ja/index.xml?catid=install">インストール関連ドキュメント</a></li><li><a href="http://www.gentoo.org/doc/ja/index.xml?catid=desktop">Gentooデスクトップドキュメント</a></li><li><a href="http://www.gentoo.org/doc/ja/index.xml?catid=gentoo">Gentooシステムドキュメント</a></li><li><a href="http://www.gentoo.org/doc/ja/index.xml?catid=sysadmin">システム管理ドキュメント</a></li><li><a href="http://www.gentoo.org/doc/ja/index.xml?catid=gentoodev">Gentoo開発ドキュメント</a></li><li><a href="http://www.gentoo.org/doc/ja/index.xml?catid=project">プロジェクト関連ドキュメント</a></li><li><a href="http://www.gentoo.org/doc/ja/index.xml?catid=other">その他のドキュメント</a></li></ul><h4>クイックリンク</h4><ul><li><a href="http://www.gentoo.org/news/ja/gmn/">GMN日本語</a></li><li><a href="http://www.gentoo.org/doc/ja/printing-howto.xml">印刷環境構築ガイド</a></li><li><a href="http://www.gentoo.org/doc/ja/xorg-config.xml">X サーバー設定ガイド</a></li><li><a href="http://www.gentoo.org/doc/ja/gentoo-security.xml">セキュリティガイド</a></li><li><a href="http://www.gentoo.org/doc/ja/faq.xml">FAQ</a></li><li><a href="/jpmain/tips.html">TIPS集</a></li><li><a href="/jpmain/docs-list.html">ドキュメント一覧</a></li></ul><h4>プロジェクト</h4><ul><li><a href="/jpmain/original-doc.html">オリジナルドキュメント</a></li><li><a href="/jpmain/translation.html">翻訳</a><a href="/jpmain/trans_status.html">[状況]</a></li><li><a href="/jpmain/project-gwn.html">GWN翻訳</a></li></ul><h4>その他</h4><ul><li><a href="http://wiki.gentoo.gr.jp/">GentooJP Wiki</a></li><li><a href="/jpmain/about-gentoojp.html#doc_chap4">メーリングリスト</a></li><li><a href="/jpmain/about-gentoojp.html#doc_chap5">IRC</a></li><li><a href="/jpmain/sponsors.html">スポンサー</a></li></ul></td><td valign="top"><div class="day"><div class="body"><div class="section"><table width="100%" border="0" cellspacing="0" cellpadding="0" style="margin-top: 0em;"><tr><td valign="top" align="right" colspan="1" bgcolor="#ffffff"><table border="0" cellspacing="0" cellpadding="0" width="100%" style="margin-top: 0em;"><tr><td width="99%" class="content" valign="top" align="left"><br></br><h1>Gentoo Linux 負荷分散ガイド</h1><table width="80%" border="0" style="border: #FF7711 3px dotted;"><tr><td> 
このガイドではLVS,NFS,Heartbeat,Ldirectord,DRBD等のソフトウェアを用いて高可用性を持つ負荷分散システムを構築する方法を解説します。
</td></tr></table><table border="0" style="border: #dddddd 3px dotted;"><tr><td>このドキュメントの著作権はAuthorの方に帰属します。<br></br>詳しくは<a href="/jpmain/original-doc.html">オリジナルドキュメントプロジェクト</a>を参照してください。</td></tr></table><br></br><br></br><table border="0" width="100%"><tr><td><b>Contents</b>:<br></br>1. <a href="#doc_chap1">はじめに</a><br></br>2. <a href="#doc_chap2">インストール</a><br></br>3. <a href="#doc_chap3">設定</a><br></br></td><td align="right" valign="top" style="padding-right: 1.0em;"><span xmlns="" style="white-space:nowrap;"><i>Author</i>
		:
		<b><a class="altlink" href="mailto:syuu@dokukino.com">Takuya Asada</a></b></span><br xmlns=""><br></br>
														Updated January 24, 2005</td></tr></table><br></br><br></br><h2 xmlns="">
<a name="doc_chap1">1.</a>はじめに</h2>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap1_sect1">負荷分散とは？ </a></p>
<p xmlns="">
負荷分散とは、ロードバランサという装置を介して、Webアクセス等の負荷の大きい処理を複数のサーバに分散する機能の事です。<br>
このドキュメントでは、Gentoo Linuxが予めインストールされたサーバ群（４台）の上に、<br>
LVS,Ldirectord,NFS,Heartbeat,DRBD等のソフトウェアを用いて高可用性を持つ負荷分散システムを構築します。
</p>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap1_sect2">高可用性とは？ </a></p>
<p xmlns="">
一台のサーバの障害によって、システムのダウンが起こらないような稼働率の高いシステムの事です。<br>
具体的には、障害時にサーバのフェイルオーバを行う等の手法が採られます。<br>
フェイルオーバに関する詳細な情報は、<a href="failover.html">Gentoo Linux フェイルオーバーガイド</a>を参照してください。
</p>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap1_sect3">LVS(Linux Virtual Server)とは？ </a></p>
<p xmlns="">
LVSは、複数のサーバを一つの仮想サーバとして扱い、IPレベルの負荷分散をするソフトウェアです。<br>
LVSをインストールする事により、Linuxサーバ上にロードバランサを実装する事が可能になります。<br>
詳細は、<a href="http://ultramonkey.jp/2.0.1/lvs.html">Ultra Monkey: The Linux Virtual Server</a>が参考になります。<br>
LVSには、<a href="http://www.linuxvirtualserver.org/deployment.html">様々な用途での実績</a>があります（最も良く知られているものとしてはsourceforge.netが挙げられます）。
</p>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap1_sect4">Ldirectordとは？ </a></p>
<p xmlns="">
Ldirectordは、実サーバ※ に対してHTTP・FTP等のプロトコルでの接続テストを定期的に行い、サーバが正しく動作しているかチェックします。<br>
サーバが正しく動作していないと判断した場合、LVSに通知してダウンしたサーバへの分散処理を停止します。<br>
これにより、実サーバがダウンした場合にも影響を受けずに、サービスを続行することが出来ます。<br>
詳細は、<a href="http://ultramonkey.jp/2.0.1/ldirectord.html">Ultra Monkey: Ldirectord</a>が参考になります。
</p>
<table xmlns="" class="ncontent" width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#bbffbb"><p class="note"><b>Note: </b>※実（リアル）サーバ… 分散先のサーバ。実際の処理を受け持つ。以下実サーバと記述</p></td></tr></table>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap1_sect5">NFSとは？ </a></p>
<p xmlns="">
UNIX/Linux等のオペレーティングシステムが稼働しているコンピュータ間でファイルを共有する為のプロトコルです。<br>
Windowsに於けるSMB/CIFS、Macintoshに於けるAFSに相当します。<br>
詳細は、<a href="http://www.linux.or.jp/JF/JFdocs/NFS-HOWTO/">Linux NFS-HOWTO</a>が参考になります。
</p>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap1_sect6">Heartbeatとは？ </a></p>
<p xmlns="">
Heartbeatは、サーバの障害を検知し、IPアドレスやサービスの引継ぎを実現するソフトウェアです。<br>
詳細は、<a href="http://ultramonkey.jp/2.0.1/heartbeat.html">Ultra Monkey: Heartbeat</a>が参考になります。
</p>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap1_sect7">DRBDとは？ </a></p>
<p xmlns="">
DRBDは、ブロックデバイスをネットワークを介してミラーリングするソフトウェアです。<br>
DRBDを利用することにより、障害発生時にデータを引き継ぐ事が可能になります。<br>
詳細は、<a href="http://www.wbc.co.jp/~drbd/documentation/HOWTO/">DRBD HOWTO</a>が参考になります。
</p>
<h2 xmlns="">
<a name="doc_chap2">2.</a>インストール</h2>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap2_sect1">前提 </a></p>
<ul xmlns="">
<li>ロードバランサ（運用系）・ファイル/LDAPサーバ（待機系）のホスト名はsrv01、IPアドレスは192.168.1.101とします。</li>
<li>ファイル/LDAPサーバ（運用系）・ロードバランサ（待機系）のホスト名はsrv02、IPアドレスは192.168.1.102とします。</li>
<li>実サーバは２台あり、それぞれホスト名srv03・IPアドレス192.168.1.103、ホスト名srv04・IPアドレス192.168.1.104とします。</li>
<li>負荷分散の対象とするIPアドレスは192.168.4.11とします。 このIPアドレスに対するアクセスは、srv03,srv04へ分散されてリダイレクトされます。<br>
	また、srv01がダウンした場合、このIPアドレスは自動的にsrv02に引き継がれ、実サーバからはサーバが稼動し続けているように見えます。</li>
<li>ファイル/LDAPサーバのIPアドレスは192.168.4.12とします。<br>
srv02がダウンした場合、このIPアドレスは自動的にsrv01に引き継がれ、実サーバからはサーバが稼働し続けているように見えます。</li>
<li>Heartbeat、DRBD等のフェイルオーバと共通するソフトウェアの設定は、<a href="failover.html">Gentoo Linux フェイルオーバーガイド</a>の設定をベースにしています。<br>
これらについての詳細は、このドキュメントでは触れません。<br>
この事は、負荷分散システムの構築がフェイルオーバシステムの応用である事を意味します。</li>
</ul>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap2_sect2">カーネル構築（ロードバランサ） </a></p>
<p xmlns="">最初に、ロードバランサのカーネルをLVSに対応させます。<br>
この作業はsrv01/02で行う必要があります。
</p>
<a xmlns="" name="doc_chap2_pre1"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 2.1: .config</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
<font class="comment">// 以下のモジュールを有効化します。
menuconfigでは、Networking options-&gt;Network packet filteringと
Networking options-&gt;IP: Virtual Server Configurationです。
</font>
CONFIG_NETFILTER=y

CONFIG_IP_VS=m
CONFIG_IP_VS_DEBUG=y
CONFIG_IP_VS_TAB_BITS=12
CONFIG_IP_VS_RR=m
CONFIG_IP_VS_WRR=m
CONFIG_IP_VS_LC=m
CONFIG_IP_VS_WLC=m
CONFIG_IP_VS_LBLC=m
CONFIG_IP_VS_LBLCR=m
CONFIG_IP_VS_DH=m
CONFIG_IP_VS_SH=m
CONFIG_IP_VS_SED=m
CONFIG_IP_VS_NQ=m
CONFIG_IP_VS_FTP=m
</pre></td></tr>
</table>
<a xmlns="" name="doc_chap2_pre2"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 2.2: カーネルコンパイル</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
srv01/02# <font class="input" color="blue">make dep clean bzImage modules modules_install &amp;&amp; \</font>
          <font class="input" color="blue">mount /boot &amp;&amp; cp arch/i386/boot/bzImage /boot/kernel-2.4.28-gentoo-r5</font>
</pre></td></tr>
</table>
<p xmlns="">コンパイルが終わったらgrubやlilo等のBoot Loaderを設定し、再起動してください。</p>
<table xmlns="" class="ncontent" width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#bbffbb"><p class="note"><b>Note: </b>
LVSに対応しているカーネルを使用する必要があります。<br>
現在の2.4の最新版（2.4.28）では既にLVSが含まれていますが、一部のより古いバージョンではパッチを当てる必要があります。
</p></td></tr></table>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap2_sect3">カーネル構築（実サーバ） </a></p>
<p xmlns="">実サーバでは、隠しデバイスに対応させる為のパッチが必要になります。<br>
この作業はsrv03/04で行う必要があります。
</p>
<a xmlns="" name="doc_chap2_pre3"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 2.3: パッチ適用</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
srv03/04# <font class="input" color="blue">cd /usr/src/linux-2.4.28-gentoo-r5</font>
srv03/04# <font class="input" color="blue">wget http://www.ssi.bg/~ja/hidden-2.4.28-1.diff</font>
srv03/04# <font class="input" color="blue">patch -p1 &lt; hidden-2.4.28-1.diff</font>
srv03/04# <font class="input" color="blue">make menuconfig</font>
srv03/04# <font class="input" color="blue">make dep clean bzImage modules modules_install &amp;&amp; \</font>
          <font class="input" color="blue">mount /boot &amp;&amp; cp arch/i386/boot/bzImage /boot/kernel-2.4.28-gentoo-r5</font>
</pre></td></tr>
</table>
<p xmlns="">コンパイルが終わったらgrubやlilo等のBoot Loaderを設定し、再起動してください。</p>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap2_sect4">インストール（ロードバランサ） </a></p>
<p xmlns="">前提となるUSEフラグは以下の通りです。</p>
<a xmlns="" name="doc_chap2_pre4"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 2.4: USEフラグ</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
apache2 bzlib cjk crypt innodb ldap ldirectord maildir memlimit nls \
pam readline xml xml2 zlib
</pre></td></tr>
</table>
<p xmlns="">
パッケージをインストールします。<br>
この作業はsrv01/02で行う必要があります。
</p>
<a xmlns="" name="doc_chap2_pre5"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 2.5: インストール</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
# <font class="input" color="blue">cd /usr/src</font>
# <font class="input" color="blue">ln -sf linux-`uname -r` linux</font>
# <font class="input" color="blue">emerge drbd heartbeat ipvsadm nfs-utils</font>
</pre></td></tr>
</table>
<table xmlns="" class="ncontent" width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#bbffbb"><p class="note"><b>Note: </b>DRBDのコンパイルには、現在使用しているカーネルのソースディレクトリから/usr/src/linuxへシンボリックリンクを張っておく必要があります。</p></td></tr></table>
<table xmlns="" class="ncontent" width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#bbffbb"><p class="note"><b>Note: </b>DRBD 0.6はkernel 2.6に対応していないため、2.4である必要があります。</p></td></tr></table>
<table xmlns="" class="ncontent" width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#bbffbb"><p class="note"><b>Note: </b>DRBDはカーネルモジュールとしてコンパイルされるので、カーネルモジュールを有効にしている必要があります。</p></td></tr></table>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap2_sect5">インストール（実サーバ） </a></p>
<p xmlns="">前提となるUSEフラグは以下の通りです。</p>
<a xmlns="" name="doc_chap2_pre6"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 2.6: USEフラグ</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
apache2 bzlib cjk crypt innodb ldap ldirectord maildir memlimit nls \
pam readline xml xml2 zlib
</pre></td></tr>
</table>
<p xmlns="">
パッケージをインストールします。<br>
この作業はsrv03/04で行う必要があります。
</p>
<a xmlns="" name="doc_chap2_pre7"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 2.7: インストール</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
# <font class="input" color="blue">emerge nfs-utils =apache-* nss_ldap pam_ldap</font>
<font class="comment">// ドキュメント作成の時点ではGentoo LinuxのPortageツリーにあるProFTPDはLDAPの動作に問題が有った※ ため、
ここではパッチ済のebuildを使用します</font>
# <font class="input" color="blue">cd /usr/local</font>
# <font class="input" color="blue">wget http://ekinoco.dokukino.com/ekinoco.tbz2</font>
# <font class="input" color="blue">tar xjf ekinoco.tbz2</font>
# <font class="input" color="blue">PORTDIR_OVERLAY="/usr/local/ekinoco" USE="ldap" \
emerge ekinoco/net-ftp/proftpd-nlst-ldapv3/proftpd-nlst-ldapv3-1.2.10.ebuild</font>
</pre></td></tr>
</table>
<table xmlns="" class="ncontent" width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#bbffbb"><p class="note"><b>Note: </b>※ <a href="failover.html#doc_chap2_sect2">Gentoo Linux フェイルオーバーガイド</a>を参照してください。</p></td></tr></table>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap2_sect6">Heartbeatのresourceスクリプト（ロードバランサ） </a></p>
<p xmlns="">
ロードバランサに対してNFSサーバの設定をします。<br><a href="failover.html#doc_chap2_sect3">Gentoo Linux フェイルオーバーガイド</a>を参照してください。<br>
この作業はsrv01/02で行う必要があります。
</p>
<h2 xmlns="">
<a name="doc_chap3">3.</a>設定</h2>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap3_sect1">カーネル（ロードバランサ） </a></p>
<p xmlns="">ロードバランサがパケットをリダイレクトできるように、パケットフォワーディングを有効化します。<br>
この作業はsrv01/02で行う必要があります。</p>
<a xmlns="" name="doc_chap3_pre1"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.1: sysctl.conf</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
net.ipv4.ip_forward = 1
</pre></td></tr>
</table>
<a xmlns="" name="doc_chap3_pre2"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.2: sysctl</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
srv01/02# <font class="input" color="blue">sysctl -p</font>
</pre></td></tr>
</table>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap3_sect2">カーネル（実サーバ） </a></p>
<p xmlns="">実サーバの隠しインターフェースの設定をします。<br>
これは、ロードバランサからリダイレクトされてくるパケットが自分宛であると認識させる為に必要です。<br>
この為にインターフェースlo:0を使用するので、initスクリプトの修正が必要になります。<br>
この作業はsrv03/04で行う必要があります。
</p>
<a xmlns="" name="doc_chap3_pre3"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.3: /etc/init.d/net.lo</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
start() {
        ebegin "Bringing ${IFACE} up"
        /sbin/ifconfig lo 127.0.0.1 up 2&gt;/dev/null
		<font class="input" color="blue">/sbin/ifconfig lo:0 192.168.4.11 netmask 255.255.255.255 up 2&gt;/dev/null</font>
        /sbin/route add -net 127.0.0.0 netmask 255.0.0.0 \
                gw 127.0.0.1 dev lo 2&gt; /dev/null
        eend 0
}

stop() {
        ebegin "Bringing ${IFACE} down"
        /sbin/ifconfig ${IFACE} down &amp;&gt;/dev/null
        eend 0
}
</pre></td></tr>
</table>
<a xmlns="" name="doc_chap3_pre4"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.4: rc-udate</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
srv03/04# rc-update add net.lo default
</pre></td></tr>
</table>
<p xmlns="">また、インターフェースを隠しインターフェースとして設定する為に、sysctl.confに以下の内容を追記し、再ロードします。</p>
<a xmlns="" name="doc_chap3_pre5"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.5: sysctl.conf</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
net.ipv4.conf.all.hidden = 1
net.ipv4.conf.lo.hidden = 1
</pre></td></tr>
</table>
<a xmlns="" name="doc_chap3_pre6"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.6: sysctl</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
srv03/04# <font class="input" color="blue">sysctl -p</font>
</pre></td></tr>
</table>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap3_sect3">DRBD（ロードバランサ） </a></p>
<p xmlns="">
ロードバランサに対して、DRBDを設定します。<br><a href="failover.html#doc_chap3_sect3">Gentoo Linux フェイルオーバーガイド</a>を参照してください。<br>
但し、drbd0と同時にdrbd1を定義して下さい。この事は、ファイル/LDAPサーバとロードバランサを分離する為に必要です。<br>
この作業はsrv01/02で行う必要があります。
</p>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap3_sect4">NFS（ロードバランサ） </a></p>
<p xmlns="">
ロードバランサに対してNFSサーバの設定をします。<br><a href="failover.html#doc_chap3_sect12">Gentoo Linux フェイルオーバーガイド</a>を参照してください。<br>
但し、drbd1上に設定して下さい。この事は、ファイル/LDAPサーバとロードバランサを分離する為に必要です。<br>
この作業はsrv01/02で行う必要があります。

</p>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap3_sect5">OpenLDAP（ロードバランサ） </a></p>
<p xmlns="">
ロードバランサに対してLDAPサーバの設定をします。<br><a href="failover.html#doc_chap3_sect6">Gentoo Linux フェイルオーバーガイド</a>を参照してください。<br>
但し、drbd1上に設定して下さい。また、IPアドレスは、192.168.4.12に読み替えてください。<br>
この事は、ファイル/LDAPサーバとロードバランサを分離する為に必要です。<br>
この作業はsrv01/02で行う必要があります。
</p>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap3_sect6">ipvsadm（ロードバランサ） </a></p>
<p xmlns="">ipvsadmの設定を/mnt/drbd0/ipvsadmに保存するように設定します。<br>
（フェイルオーバ時に設定を同期させる為です。）<br>
/mnt/drbd0の中のファイルの設定は、全てsrv01から行います。
</p>
<a xmlns="" name="doc_chap3_pre7"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.7: [srv01] mkdir</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
srv01# <font class="input" color="blue">mkdir -p /mnt/drbd0/ipvsadm/data</font>
</pre></td></tr>
</table>
<p xmlns="">Heartbeatのresourceスクリプトに対応する変数定義ファイルを用意します。</p>
<a xmlns="" name="doc_chap3_pre8"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.8: [srv01] /mnt/drbd0/init/ipvsadm</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
opts="start stop save"
RULES=/mnt/drbd0/ipvsadm/data/rules
</pre></td></tr>
</table>
<p xmlns="">LVSでの負荷分散を設定するには、ipvsadmというLVSの管理コマンドを使う必要があります。<br>
コマンドは、以下のような非常に単純なものです：</p>
<a xmlns="" name="doc_chap3_pre9"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.9: [srv01] ipvsadm</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
srv01# <font class="input" color="blue">ipvsadm -A -t 192.168.4.11:80</font>
srv01# <font class="input" color="blue">ipvsadm -a -t 192.168.4.11:80 -r 192.168.1.103:80 -g</font>
srv01# <font class="input" color="blue">ipvsadm -a -t 192.168.4.11:80 -r 192.168.1.104:80 -g</font>
<font class="comment">// 設定が終わったら、drbd0に保存します：</font>
srv01# <font class="input" color="blue">/etc/ha.d/resource.d/ipvsadm /mnt/drbd0/init/ipvsadm save</font>
</pre></td></tr>
</table>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap3_sect7">Heartbeat/Ldirectord（ロードバランサ） </a></p>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap3_sect8">NFS（実サーバ） </a></p>
<p xmlns="">実サーバに対してNFSクライアントの設定をします。<br><a href="failover.html#doc_chap3_sect13">Gentoo Linux フェイルオーバーガイド</a>を参照してください。<br>
但し、drbd1上に設定して下さい。また、IPアドレスは、192.168.4.12に読み替えてください。<br>
この事は、ファイル/LDAPサーバとロードバランサを分離する為に必要です。<br>
この作業はsrv03/04で行う必要があります。
</p>
<p xmlns="">また、ホームディレクトリを作成しておいてください。</p>
<a xmlns="" name="doc_chap3_pre14"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.14: mkdir</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
# <font class="input" color="blue">mkdir /mnt/nfs/home</font>
</pre></td></tr>
</table>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap3_sect9">OpenLDAP（実サーバ） </a></p>
<p xmlns="">実サーバに対してLDAPクライアントの設定をします。<br><a href="failover.html#doc_chap3_sect7">Gentoo Linux フェイルオーバーガイド</a>を参照してください。<br>
但し、drbd1上に設定して下さい。また、IPアドレスは、192.168.4.12に読み替えてください。<br>
更に、ユーザの追加例のホームディレクトリを/mnt/nfs/home/[ユーザ名]と読み替えてください。<br>
この事は、ファイル/LDAPサーバとロードバランサを分離する為に必要です。<br>
この作業はsrv03/04で行う必要があります。
</p>
<a xmlns="" name="doc_chap3_pre15"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.15: ~/test01.ldif</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
dn: uid=test01,ou=People,dc=cluster1,dc=dokukino,dc=com
uid: test01
cn: test01
sn: test01
loginShell: /bin/bash
uidNumber: 2001
gidNumber: 2001
homeDirectory: /mnt/nfs/home/test01
shadowMin: -1
shadowMax: 999999
shadowWarning: 7
shadowInactive: -1
shadowExpire: -1
shadowFlag: 0
objectClass: top
objectClass: person
objectClass: posixAccount
objectClass: shadowAccount
</pre></td></tr>
</table>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap3_sect10">Apache（実サーバ） </a></p>
<p xmlns="">Apacheの設定・データを/mnt/nfsに用意します。<br>
但し、logとpidファイルはNFS上には置きません。設定とデータのみを共通化します。<br>
この作業は、全てsrv03から行います。</p>
<a xmlns="" name="doc_chap3_pre16"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.16: [srv03] /mnt/nfs/apache2に設定・データを用意する</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
srv03# <font class="input" color="blue">cd /mnt/nfs</font>
srv03# <font class="input" color="blue">mkdir apache2</font>
srv03# <font class="input" color="blue">cd apache2/</font>
srv03# <font class="input" color="blue">mkdir conf www</font>
srv03# <font class="input" color="blue">ln -s /var/log/apache2 logs</font>
srv03# <font class="input" color="blue">ln -l /usr/lib/apache2</font>
srv03# <font class="input" color="blue">ls -l /usr/lib/apache2</font>
srv03# <font class="input" color="blue">ln -s /usr/lib/apache2/build ./</font>
srv03# <font class="input" color="blue">ln -s /usr/lib/apache2-extramodules ./extramodules</font>
srv03# <font class="input" color="blue">ls -l</font>
srv03# <font class="input" color="blue">ln -s /usr/lib ./</font>
srv03# <font class="input" color="blue">ln -s /usr/lib/apache2/modules ./</font>
srv03# <font class="input" color="blue">cd /etc/apache2/conf/</font>
srv03# <font class="input" color="blue">cp -a magic mime.types modules.d php.ini ssl vhosts /mnt/nfs/apache2/conf/</font>
srv03# <font class="input" color="blue">cd -</font>
srv03# <font class="input" color="blue">cp -a /var/www/* www/</font>
</pre></td></tr>
</table>
<p xmlns="">
apache2.conf、commonapache2.confを参考にして、パスを書き換えた設定ファイルを作成します。
</p>
<a xmlns="" name="doc_chap3_pre17"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.17: [srv01] /mnt/nfs/apache2/conf/apache2.conf</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
<font class="comment">// 変更すべき部分のみ抜粋</font>
ServerRoot /mnt/nfs/apache2
DocumentRoot /mnt/nfs/apache2/www/localhost/htdocs
</pre></td></tr>
</table>
<a xmlns="" name="doc_chap3_pre18"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.18: [srv01] /mnt/nfs/apache2/conf/commonapache2.conf</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
<font class="comment">// 変更すべき部分のみ抜粋</font>
&lt;IfModule mod_alias.c&gt;
    Alias /icons/ /mnt/nfs/apache2/www/localhost/icons/
    Alias /doc /usr/share/doc
    ScriptAlias /cgi-bin/ /mnt/nfs/apache2/www/localhost/cgi-bin/
    ScriptAlias /protected-cgi-bin/ /mnt/nfs/apache2/www/localhost/protected-cgi-bin/
    ScriptAliasMatch ^/~([^/]*)/cgi-bin/(.*) /mnt/nfs/home/$1/public_html/cgi-bin/$2
    &lt;IfModule mod_perl.c&gt;
	Alias /perl/ /mnt/nfs/apache2/www/localhost/perl/
	Alias /cgi-perl/ /mnt/nfs/apache2/www/localhost/perl/
    &lt;/IfModule&gt;
&lt;/IfModule&gt;

&lt;IfModule mod_deflate.c&gt;
	&lt;Directory "/mnt/nfs/apache2/www/localhost/htdocs/manual"&gt;

&lt;Directory /mnt/nfs/apache2/www/localhost/htdocs&gt;
	
&lt;Directory /mnt/nfs/apache2/www/localhost/perl&gt;

&lt;Directory /mnt/nfs/apache2/www/localhost/cgi-bin&gt;

&lt;Directory /mnt/nfs/apache2/www/localhost/protected-cgi-bin&gt;

&lt;Directory /mnt/nfs/home/*/public_html&gt;

&lt;Directory /mnt/nfs/home/*/public_html/cgi-bin&gt;

&lt;IfModule mod_perl.c&gt;
    &lt;Directory /mnt/nfs/home/*/public_html/perl&gt;
	
&lt;Directory /mnt/nfs/apache2/www/localhost/icons&gt;

&lt;IfModule mod_alias.c&gt;
AliasMatch ^/manual(?:/(?:de|en|fr|ja|ko|ru))?(/.*)?$ \
"/mnt/nfs/apache2/www/localhost/htdocs/manual/$1"

&lt;Directory "/mnt/nfs/apache2/www/localhost/htdocs/manual"&gt;
</pre></td></tr>
</table>
<p xmlns="">
webapp-configのVHOST_ROOTを以下のように書き換えます。<br>
この作業は両方のサーバで行う必要があります。
</p>
<a xmlns="" name="doc_chap3_pre19"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.19: /etc/vhosts/webapp-config</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
<font class="comment">// 変更すべき部分のみ抜粋</font>
VHOST_ROOT="/mnt/nfs/apache2/www/${G_HOSTNAME}"
</pre></td></tr>
</table>
<p xmlns="">
conf.dの設定を以下のように書き換えます。<br>
この作業は、両方のサーバで行う必要があります。
</p>
<a xmlns="" name="doc_chap3_pre20"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.20: /etc/conf.d/apache2</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
SERVERROOT=/mnt/nfs/apache2
CONFIGFILE=conf/apache2.conf
PIDFILE=/var/run/apache2.pid
RESTARTSTYLE="graceful"
</pre></td></tr>
</table>
<p xmlns="">Apacheを起動します。<br>
この作業は両方のサーバで行う必要があります。</p>
<a xmlns="" name="doc_chap3_pre21"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.21: apacheを起動</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
srv03/04# <font class="input" color="blue">rc-update add apache2 default</font>
srv03/04# <font class="input" color="blue">/etc/init.d/apache2 start</font>
</pre></td></tr>
</table>
<p xmlns="" class="secthead" style="color: #6A3000 ! important;"><a name="doc_chap3_sect11">ProFTPD（実サーバ） </a></p>
<p xmlns="">
ProFTPDの設定・データを/mnt/nfs/proftpdに用意します。
/mnt/nfsの中のファイルの設定は、全てsrv03から行います。
</p>
<a xmlns="" name="doc_chap3_pre22"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.22: [srv03] /mnt/nfs/proftpdに設定・データを用意する</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
srv03# <font class="input" color="blue">mkdir -p /mnt/nfs/proftpd/conf</font>
</pre></td></tr>
</table>
<p xmlns="">
proftpd.conf.distrib等を参考にして、proftpd.confを作成します。
</p>
<a xmlns="" name="doc_chap3_pre23"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.23: [srv03] /mnt/nfs/proftpd/conf/proftpd.conf</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
ServerName                              "ProFTPD Default Installation"
ServerType                              standalone
DefaultServer                   on
Port                                    21
Umask                                   022
MaxInstances                    30
User                                    proftpd
Group                                   proftpd
DefaultRoot                             ~
AuthPAM                                 off
LDAPServer                              192.168.4.12
LDAPDoAuth                              on "ou=People,dc=cluster1,dc=dokukino,dc=com"
LDAPProtocolVersion             3
LDAPDoUIDLookups                on "ou=People,dc=cluster1,dc=dokukino,dc=com"
LDAPDoGIDLookups                on "ou=Group,dc=cluster1,dc=dokukino,dc=com"
AllowOverwrite                  on
MultilineRFC2228                on
ShowSymlinks                    on
AllowForeignAddress             on
TimesGMT                                off
IdentLookups                    off
UseReverseDNS                   off
ServerIdent                             on ""
AllowStoreRestart               on
AllowRetrieveRestart    on
AllowOverwrite                  on
RequireValidShell               off
DisplayLogin                    welcome.msg
</pre></td></tr>
</table>
<p xmlns="">conf.dの設定を以下のように書き換えます。<br>
この作業は、両方のサーバで行う必要があります。</p>
<a xmlns="" name="doc_chap3_pre24"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.24: [srv03] /etc/conf.d/proftpd</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
CONFIGFILE=/mnt/nfs/proftpd/conf/proftpd.conf
</pre></td></tr>
</table>
<p xmlns="">ProFTPDを起動します。<br>
この作業は両方のサーバで行う必要があります。</p>
<a xmlns="" name="doc_chap3_pre25"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.25: proftpdを起動</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
srv03/04# <font class="input" color="blue">rc-update add proftpd default</font>
srv03/04# <font class="input" color="blue">/etc/init.d/proftpd start</font>
</pre></td></tr>
</table>
<p xmlns="">ldirectord用に、welcome.msgを配置します。</p>
<a xmlns="" name="doc_chap3_pre26"></a><table xmlns="" class="ntable" width="100%" cellspacing="0" cellpadding="0" border="0">
<tr><td bgcolor="#8C5000" class="infohead" style="color: #FFFFFF ! important;"><font color="#FFFFFF">
								Code listing 3.26: [srv03] welcome.msgを配置</font></td></tr>
<tr><td bgcolor="#FFE9C8"><pre>
srv03# <font class="input" color="blue">echo "Welcome" &gt; /mnt/nfs/home/test01/welcome.msg</font>
</pre></td></tr>
</table></td></tr></table></td></tr></table></div></div></div></td></tr><tr height="1.3em" valign="bottom"><td height="1.3em" valign="bottom"><div class="footer">[ <a href="http://ml.gentoo.gr.jp/users/">users ML</a> ]
					  [ <a href="http://ml.gentoo.gr.jp/docs/">docs ML</a> ]
					  [ <a href="http://ml.gentoo.gr.jp/dev/">dev ML</a> ]
					  [ <a href="http://ml.gentoo.gr.jp/misc/">misc ML</a> ]
						[ <a href="/jpmain/about-gentoojp.html#doc_chap5">IRC</a> ]</div></td></tr></table><div align="center" class="copy">
					Copyright&copy; 2002-2005 Gentoo Linux Users Group Japan. All rights reserved.<br></br>
					このサイトはGentooJPが運営するGentoo.org非公式コミュニティサイトです。ご質問、ご意見などはこちらまで。 Email: <a href="mailto:www@gentoo.gr.jp">www@gentoo.gr.jp</a></div></body></html>
